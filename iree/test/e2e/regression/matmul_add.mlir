// RUN: [[ $IREE_LLVMJIT_DISABLE == 1 ]] || (iree-run-mlir -export-all -iree-hal-target-backends=llvm-ir %s | IreeFileCheck %s)
// RUN: [[ $IREE_VULKAN_DISABLE == 1 ]] || (iree-run-mlir -export-all -iree-hal-target-backends=vulkan-spirv %s | IreeFileCheck %s)

// func @matmul_add() -> tensor<2x4xf32> {
//   %0 = iree.unfoldable_constant dense<[
//     [1.0,  2.0,  3.0,  4.0,  5.0,  6.0,  7.0,  8.0],
//     [9.0, 10.0, 11.0, 12.0, 13.0, 14.0, 15.0, 16.0]]> : tensor<2x8xf32>
//   %1 = iree.unfoldable_constant dense<[
//     [ 1.0,  2.0,  3.0,  4.0],
//     [ 5.0,  6.0,  7.0,  8.0],
//     [ 9.0, 10.0, 11.0, 12.0],
//     [13.0, 14.0, 15.0, 16.0],
//     [17.0, 18.0, 19.0, 20.0],
//     [21.0, 22.0, 23.0, 24.0],
//     [25.0, 26.0, 27.0, 28.0],
//     [29.0, 30.0, 31.0, 32.0]]> : tensor<8x4xf32>
//   %2 = iree.unfoldable_constant dense<[
//     [1.0, 2.0, 3.0, 4.0],
//     [5.0, 6.0, 7.0, 8.0]]> : tensor<2x4xf32>
//   %workload = constant 8 : index
//   %3 = flow.dispatch.region[%workload: index]
//     (%arg0 = %0 : tensor<2x8xf32>, %arg1 = %1 : tensor<8x4xf32>,
//      %arg2 = %2 : tensor<2x4xf32>) -> tensor<2x4xf32> {
//     %4 = "mhlo.dot"(%arg0, %arg1) :
//       (tensor<2x8xf32>, tensor<8x4xf32>) -> tensor<2x4xf32>
//     %5 = mhlo.add %4, %arg2 : tensor<2x4xf32>
//     flow.return %5 : tensor<2x4xf32>
//   }
//   return %3 : tensor<2x4xf32>
// }

// // CHECK: EXEC @matmul_add
// // CHECK: 2x4xf32=[709 746 783 820][1673 1774 1875 1976]

func @matmul_add_large() -> tensor<16x48xf32> {
  %0 = iree.unfoldable_constant dense<2.0> : tensor<16x32xf32>
  %1 = iree.unfoldable_constant dense<3.0> : tensor<32x48xf32>
  %2 = iree.unfoldable_constant dense<4.0> : tensor<16x48xf32>
  %workload = constant 768 : index
  %3 = flow.dispatch.region[%workload: index]
    (%arg0 = %0 : tensor<16x32xf32>, %arg1 = %1 : tensor<32x48xf32>,
     %arg2 = %2 : tensor<16x48xf32>) -> tensor<16x48xf32> {
    %4 = "mhlo.dot"(%arg0, %arg1) :
      (tensor<16x32xf32>, tensor<32x48xf32>) -> tensor<16x48xf32>
    %5 = mhlo.add %4, %arg2 : tensor<16x48xf32>
    flow.return %5 : tensor<16x48xf32>
  }
  return %3 : tensor<16x48xf32>
}
//      CHECK: EXEC @matmul_add_large
//      CHECK: 16x48xf32=
// CHECK-SAME: [196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196]
// CHECK-SAME: [196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196]
// CHECK-SAME: [196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196]
// CHECK-SAME: [196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196]
// CHECK-SAME: [196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196]
// CHECK-SAME: [196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196]
// CHECK-SAME: [196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196]
// CHECK-SAME: [196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196]
// CHECK-SAME: [196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196]
// CHECK-SAME: [196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196]
// CHECK-SAME: [196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196]
// CHECK-SAME: [196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196]
// CHECK-SAME: [196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196]
// CHECK-SAME: [196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196]
// CHECK-SAME: [196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196]
// CHECK-SAME: [196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196
// CHECK-SAME:  196 196 196 196 196 196 196 196 196 196 196 196]

func @batch_matmul_add_large() -> tensor<2x16x32xf32> {
  %0 = iree.unfoldable_constant dense<2.0> : tensor<2x16x32xf32>
  %1 = iree.unfoldable_constant dense<3.0> : tensor<2x32x32xf32>
  %2 = iree.unfoldable_constant dense<4.0> : tensor<2x16x32xf32>
  %workload = constant 2048 : index
  %3 = flow.dispatch.region[%workload: index]
    (%arg0 = %0 : tensor<2x16x32xf32>, %arg1 = %1 : tensor<2x32x32xf32>,
     %arg2 = %2 : tensor<2x16x32xf32>) -> tensor<2x16x32xf32> {
    %4 = "mhlo.dot_general"(%arg0, %arg1) {
      dot_dimension_numbers = {
        lhs_batching_dimensions = dense<0> : tensor<1xi64>,
        lhs_contracting_dimensions = dense<2> : tensor<1xi64>,
        rhs_batching_dimensions = dense<0> : tensor<1xi64>,
        rhs_contracting_dimensions = dense<1> : tensor<1xi64>
      },
      precision_config = ["DEFAULT", "DEFAULT"]
    } : (tensor<2x16x32xf32>, tensor<2x32x32xf32>) -> tensor<2x16x32xf32>
    %5 = mhlo.add %4, %arg2 : tensor<2x16x32xf32>
    flow.return %5 : tensor<2x16x32xf32>
  }
  return %3 : tensor<2x16x32xf32>
}
//      CHECK: EXEC @batch_matmul_add_large
//      CHECK: 2x16x32xf32=
// CHECK-SAME: [
// CHECK-SAME:  [196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196]
// CHECK-SAME:  [196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196]
// CHECK-SAME:  [196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196]
// CHECK-SAME:  [196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196]
// CHECK-SAME:  [196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196]
// CHECK-SAME:  [196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196]
// CHECK-SAME:  [196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196]
// CHECK-SAME:  [196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196]
// CHECK-SAME:  [196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196]
// CHECK-SAME:  [196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196]
// CHECK-SAME:  [196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196]
// CHECK-SAME:  [196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196]
// CHECK-SAME:  [196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196]
// CHECK-SAME:  [196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196]
// CHECK-SAME:  [196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196]
// CHECK-SAME:  [196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196]
// CHECK-SAME: ][
// CHECK-SAME:  [196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196]
// CHECK-SAME:  [196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196]
// CHECK-SAME:  [196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196]
// CHECK-SAME:  [196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196]
// CHECK-SAME:  [196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196]
// CHECK-SAME:  [196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196]
// CHECK-SAME:  [196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196]
// CHECK-SAME:  [196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196]
// CHECK-SAME:  [196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196]
// CHECK-SAME:  [196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196]
// CHECK-SAME:  [196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196]
// CHECK-SAME:  [196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196]
// CHECK-SAME:  [196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196]
// CHECK-SAME:  [196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196]
// CHECK-SAME:  [196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196]
// CHECK-SAME:  [196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196
// CHECK-SAME:   196 196 196 196 196 196 196 196]
// CHECK-SAME: ]
