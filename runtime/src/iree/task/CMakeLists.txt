################################################################################
# Autogenerated by build_tools/bazel_to_cmake/bazel_to_cmake.py from           #
# runtime/src/iree/task/BUILD                                                  #
#                                                                              #
# Use iree_cmake_extra_content from iree/build_defs.oss.bzl to add arbitrary   #
# CMake-only content.                                                          #
#                                                                              #
# To disable autogeneration for this file entirely, delete this header.        #
################################################################################

iree_add_all_subdirs()

if(NOT NUMA_HEADERS_API_ROOT)
  set(NUMA_HEADERS_API_ROOT "${IREE_ROOT_DIR}/third_party/numactl/")
  message(STATUS "Using default NUMA directory at ${NUMA_HEADERS_API_ROOT}")
endif()

if(EXISTS ${NUMA_HEADERS_API_ROOT})
  message(STATUS "NUMA Header Path: ${NUMA_HEADERS_API_ROOT}")
else()
  message(SEND_ERROR "Could not locate NUMA: ${NUMA_HEADERS_API_ROOT}")
endif()

# Task-based executor requires threading support.
if(NOT IREE_ENABLE_THREADING)
  return()
endif()

# cpuinfo can be conditionally disabled when it is not supported.
# If disabled then by default the task system will use 1 thread.
set(IREE_CPUINFO_TARGET)
if(IREE_ENABLE_CPUINFO)
  set(IREE_CPUINFO_TARGET cpuinfo)
endif()

#iree_cc_library(
#  NAME
#    numa
#  HDRS
#    "${NUMA_HEADERS_API_ROOT}/config.h"
#    "${NUMA_HEADERS_API_ROOT}/numa.h"
#    "${NUMA_HEADERS_API_ROOT}/numaif.h"
#    "${NUMA_HEADERS_API_ROOT}/numaint.h"
#    "${NUMA_HEADERS_API_ROOT}/util.h"
#    "${NUMA_HEADERS_API_ROOT}/shm.h"
#  SRCS
#    "${NUMA_HEADERS_API_ROOT}/libnuma.c"
#  PUBLIC
#)

iree_cc_library(
  NAME
    api
  HDRS
    "api.h"
    "${NUMA_HEADERS_API_ROOT}/config.h"
    "${NUMA_HEADERS_API_ROOT}/numa.h"
    "${NUMA_HEADERS_API_ROOT}/numaif.h"
    "${NUMA_HEADERS_API_ROOT}/numaint.h"
    "${NUMA_HEADERS_API_ROOT}/util.h"
    "${NUMA_HEADERS_API_ROOT}/shm.h"
  SRCS
    "api.c"
  DEPS
    /usr/lib/x86_64-linux-gnu/libnuma.so
    ::task
    iree::base
    iree::base::internal::flags
    iree::base::tracing
  PUBLIC
)

iree_cc_library(
  NAME
    task
  HDRS
    "affinity_set.h"
    "executor.h"
    "list.h"
    "poller.h"
    "pool.h"
    "queue.h"
    "scope.h"
    "submission.h"
    "task.h"
    "topology.h"
    "tuning.h"
  SRCS
    "executor.c"
    "executor_impl.h"
    "list.c"
    "poller.c"
    "pool.c"
    "post_batch.c"
    "post_batch.h"
    "queue.c"
    "scope.c"
    "submission.c"
    "task.c"
    "task_impl.h"
    "topology.c"
    "topology_cpuinfo.c"
    "worker.c"
    "worker.h"
  DEPS
    ${IREE_CPUINFO_TARGET}
    iree::base
    iree::base::core_headers
    iree::base::internal
    iree::base::internal::atomic_slist
    iree::base::internal::cpu
    iree::base::internal::event_pool
    iree::base::internal::fpu_state
    iree::base::internal::prng
    iree::base::internal::synchronization
    iree::base::internal::threading
    iree::base::internal::wait_handle
    iree::base::tracing
  PUBLIC
)

iree_cc_test(
  NAME
    executor_demo
  SRCS
    "executor_demo.cc"
  DEPS
    ::task
    iree::base
    iree::base::internal::prng
    iree::base::tracing
    iree::task::testing::test_util
)

iree_cc_test(
  NAME
    executor_test
  SRCS
    "executor_test.cc"
  DEPS
    ::task
    iree::base
    iree::task::testing::test_util
    iree::testing::gtest
    iree::testing::gtest_main
)

iree_cc_test(
  NAME
    list_test
  SRCS
    "list_test.cc"
  DEPS
    ::task
    iree::base
    iree::task::testing::test_util
    iree::testing::gtest
    iree::testing::gtest_main
)

iree_cc_test(
  NAME
    pool_test
  SRCS
    "pool_test.cc"
  DEPS
    ::task
    iree::base
    iree::task::testing::test_util
    iree::testing::gtest
    iree::testing::gtest_main
)

iree_cc_test(
  NAME
    queue_test
  SRCS
    "queue_test.cc"
  DEPS
    ::task
    iree::base
    iree::task::testing::test_util
    iree::testing::gtest
    iree::testing::gtest_main
)

iree_cc_test(
  NAME
    scope_test
  SRCS
    "scope_test.cc"
    "task_impl.h"
  DEPS
    ::task
    iree::base
    iree::task::testing::test_util
    iree::testing::gtest
    iree::testing::gtest_main
)

iree_cc_test(
  NAME
    task_tests
  SRCS
    "task_test_barrier.cc"
    "task_test_call.cc"
    "task_test_dispatch.cc"
    "task_test_fence.cc"
    "task_test_nop.cc"
    "task_test_wait.cc"
  DEPS
    ::task
    iree::base
    iree::task::testing::task_test
    iree::testing::gtest
    iree::testing::gtest_main
)

iree_cc_test(
  NAME
    topology_test
  SRCS
    "topology_test.cc"
  DEPS
    ::task
    iree::base
    iree::testing::gtest
    iree::testing::gtest_main
  LABELS
    "noasan"
)

### BAZEL_TO_CMAKE_PRESERVES_ALL_CONTENT_BELOW_THIS_LINE ###

if(NOT IREE_ENABLE_CPUINFO)
  target_compile_definitions(iree_task_task
    PUBLIC
      "IREE_TASK_CPUINFO_DISABLED=1"
  )
endif()
