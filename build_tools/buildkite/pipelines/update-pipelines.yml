# Copyright 2022 The IREE Authors
#
# Licensed under the Apache License v2.0 with LLVM Exceptions.
# See https://llvm.org/LICENSE.txt for license information.
# SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception

agents:
  queue: "orchestration"
  security: "submitted"

steps:
  - label: "Updating presubmit pipeline configuration"
    # Ensure that only one update operation per pipeline runs at a time. See
    # https://buildkite.com/docs/pipelines/controlling-concurrency
    concurrency: 1
    concurrency_group: pipeline-update/presubmit
    commands: |
      export BUILDKITE_ACCESS_TOKEN="$(gcloud secrets versions access latest \
          --secret=iree-buildkite-privileged)"
      build_tools/buildkite/scripts/update_pipeline_configuration.py \
          presubmit \
          --file build_tools/buildkite/pipelines/presubmit.yml

  - label: "Updating postsubmit pipeline configuration"
    # Ensure that only one update operation per pipeline runs at a time. See
    # https://buildkite.com/docs/pipelines/controlling-concurrency
    concurrency: 1
    concurrency_group: pipeline-update/postsubmit
    commands: |
      export BUILDKITE_ACCESS_TOKEN="$(gcloud secrets versions access latest \
          --secret=iree-buildkite-privileged)"
      build_tools/buildkite/scripts/update_pipeline_configuration.py \
          postsubmit \
          --file build_tools/buildkite/pipelines/postsubmit.yml
