# Copyright 2022 The IREE Authors
#
# Licensed under the Apache License v2.0 with LLVM Exceptions.
# See https://llvm.org/LICENSE.txt for license information.
# SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception

# Note: this runs on "security: submitted" agents, since this pipeline itself is
# submitted code and it fetches the scripts from the main branch.
agents:
  queue: "orchestration"
  security: "submitted"

# We're not checking out from the PR and besides saving time, we really
# don't want to because we don't want unsubmitted code on these executors at
# all.
plugins:
  - thedyrt/skip-checkout#0870506e0b5d4becc164c6e64dbc331938f0bdcf:
      cd: /tmp/

# TODO: make it possible to test this pipeline on presubmit.

steps:
  # TODO: Is there a better emoji here? Google logo (would have to add to
  # Buildkite)?
  - label: ":face_with_monocle: :admission_tickets: :raised_hand: Checking CLA"
    commands: |
      curl \
          https://raw.githubusercontent.com/google/iree/main/build_tools/buildkite/scripts/check_cla.py \
          | python3 - ${BUILDKITE_COMMIT} \
      || curl \
          https://raw.githubusercontent.com/google/iree/main/build_tools/buildkite/pipelines/cla_failure.yml \
          | buildkite-agent pipeline upload

  - wait

  - label: "Executing gcmn-test-pipeline"
    commands: |
      export BUILDKITE_ACCESS_TOKEN="$(gcloud secrets versions access latest \
          --secret=iree-buildkite-presubmit-pipelines)"
      curl \
          https://raw.githubusercontent.com/google/iree/main/build_tools/buildkite/scripts/wait_for_pipeline_success.py \
          | python3 - gcmn-test-pipeline
