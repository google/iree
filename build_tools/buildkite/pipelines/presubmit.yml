# Copyright 2022 The IREE Authors
#
# Licensed under the Apache License v2.0 with LLVM Exceptions.
# See https://llvm.org/LICENSE.txt for license information.
# SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception

# Note: this runs on "security: submitted" agents, since this pipeline itself is
# submitted code and it fetches the scripts from the main branch.
agents:
  queue: "orchestration"
  security: "submitted"

plugins:
  - https://github.com/GMNGeoffrey/smooth-checkout-buildkite-plugin#configurable-dirs
      repos:
        - config:
          - url: ${BUILDKITE_REPO}
            ref: ${BUILDKITE_PIPELINE_DEFAULT_BRANCH}

# TODO: make it possible to test this pipeline on presubmit.

steps:
  # TODO: Is there a better emoji here? Google logo (would have to add to
  # Buildkite)?
  - label: ":face_with_monocle: :admission_tickets: :raised_hand: Checking CLA"
    commands: |
      ./build_tools/buildkite/scripts/check_cla.py ${BUILDKITE_COMMIT} \
          || buildkite-agent pipeline upload \
              build_tools/buildkite/pipelines/cla_failure.yml

  - wait

  - label: "Executing gcmn-test-pipeline"
    commands: |
      export BUILDKITE_ACCESS_TOKEN="$(gcloud secrets versions access latest \
          --secret=iree-buildkite-presubmit-pipelines)"
      ./build_tools/buildkite/scripts/wait_for_pipeline_success.py gcmn-test-pipeline
