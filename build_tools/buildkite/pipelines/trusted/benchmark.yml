# Copyright 2022 The IREE Authors
#
# Licensed under the Apache License v2.0 with LLVM Exceptions.
# See https://llvm.org/LICENSE.txt for license information.
# SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception

# Note: this runs on trusted agents, since it needs access to post a PR
# comment. The pipeline itself is uploaded from the main repository via
# bootstrap-trusted.yml and it fetches the scripts only from the main
# repository.
agents:
  queue: "orchestration"
  security: "trusted"

steps:
  - label: ":fast_forward: Launch Linux benchmark pipeline"
    plugins:
      - https://github.com/GMNGeoffrey/smooth-checkout-buildkite-plugin#24e54e7729:
          repos:
            - config:
                - url: ${BUILDKITE_REPO}
                  ref: ${CONFIG_FETCH_REF}
    commands:
      - "git clean -fdx"
      # TODO(pzread): Replace the jerry-benchmark-linux with the formal one.
      - |
        export BUILDKITE_ACCESS_TOKEN="$(gcloud secrets versions access latest \
            --secret=iree-buildkite-presubmit-pipelines)"
        ./build_tools/buildkite/scripts/wait_for_pipeline_success.py \
            --output-build-json=build.json jerry-benchmark-linux
      # TODO(pzread): Add jq to the agents and replace the python command.
      - |
        mkdir benchmark-results-linux
        buildkite-agent artifact download "benchmark-results-*.json" \
            benchmark-results-linux/ --build \
            $(cat build.json | python -c "import json,sys;print(json.load(sys.stdin)['id'])")
    artifact_paths:
      - "benchmark-results-linux/*.json"

  - wait

  - label: ":lower_left_crayon: Comment benchmark results on pull request"
    plugins:
      - https://github.com/GMNGeoffrey/smooth-checkout-buildkite-plugin#24e54e7729:
          repos:
            - config:
                - url: ${BUILDKITE_REPO}
                  ref: ${CONFIG_FETCH_REF}
    commands:
      - "git clean -fdx"
      - |
        export GITHUB_TOKEN="$(gcloud secrets versions access latest \
            --secret=iree-github-token)" \
        export IREE_DASHBOARD_URL="https://perf.iree.dev" \
        buildkite-agent artifact download "benchmark-results-*/*.json" .
        ./build_tools/benchmarks/post_benchmarks_as_pr_comment.py \
            --verbose --query-base \
            benchmark-results-*/*.json"
